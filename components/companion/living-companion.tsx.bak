
'use client'

import { useState, useEffect } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import Image from 'next/image'
import { MessageCircle, Mic, Settings, X, Volume2, VolumeX, BookOpen } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { CompanionSettings } from './companion-settings'
import { ImprovedVoiceChat } from './improved-voice-chat'
import { CompanionChat } from './companion-chat'
import { CompanionStoryPanel } from './companion-story-panel'
import { COMPANION_ID_MAP } from '@/lib/companion-stories'
import { KenCompanion } from './ken-animated'

interface LivingCompanionProps {
  companion: {
    id: string
    type: string
    name: string
    color_theme: string
    voice_tone: string
    personality: string
    position_x: number
    position_y: number
    is_active: boolean
  }
  onUpdate: (data: any) => void
}

export function LivingCompanion({ companion, onUpdate }: LivingCompanionProps) {
  const [showSettings, setShowSettings] = useState(false)
  const [showChat, setShowChat] = useState(false)
  const [showStory, setShowStory] = useState(false)
  const [chatMode, setChatMode] = useState<'text' | 'voice'>('voice') // Inicia en modo voz por defecto
  const [emotion, setEmotion] = useState<'neutral' | 'happy' | 'sad' | 'excited' | 'thinking' | 'anxious' | 'angry'>('neutral')
  const [action, setAction] = useState<'idle' | 'walking' | 'jumping' | 'waving' | 'dancing' | 'crying' | 'laughing'>('idle')
  const [position, setPosition] = useState({ x: 0, y: 0 })

  // Posici√≥n inicial
  useEffect(() => {
    setPosition({ x: 85, y: 10 })
  }, [])

  // Cambiar emoci√≥n aleatoriamente
  useEffect(() => {
    const emotions: Array<'neutral' | 'happy' | 'sad' | 'excited' | 'thinking' | 'anxious' | 'angry'> = 
      ['neutral', 'happy', 'excited', 'thinking']
    
    const interval = setInterval(() => {
      const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)]
      setEmotion(randomEmotion)
      
      // Volver a neutral despu√©s de un rato
      setTimeout(() => setEmotion('neutral'), 3000)
    }, 12000)

    return () => clearInterval(interval)
  }, [])

  if (!companion.is_active) {
    return null
  }

  // Mapeo de tipos a nombres de archivo de imagen
  const companionImages: Record<string, string> = {
    'human': 'companion-human-warm.png',
    'lumi': 'companion-lumi-light.png',
    'nimbo': 'companion-nimbo-cloud.png',
    'fabel': 'companion-fabel-animal.png',
    'sprig': 'companion-sprig-plant.png',
    'hada': 'companion-hada-fairy.png',
    'elfo': 'companion-elfo-elf.png',
    'draguito': 'companion-draguito-dragon.png',
    'unicornito': 'companion-unicornito-unicorn.png',
    'ken': 'ken.png',
    // Tambi√©n soportamos los tipos completos
    'human-warm': 'companion-human-warm.png',
    'lumi-light': 'companion-lumi-light.png',
    'nimbo-cloud': 'companion-nimbo-cloud.png',
    'fabel-animal': 'companion-fabel-animal.png',
    'sprig-plant': 'companion-sprig-plant.png',
    'hada-fairy': 'companion-hada-fairy.png',
    'elfo-elf': 'companion-elfo-elf.png',
    'draguito-dragon': 'companion-draguito-dragon.png',
    'unicornito-unicorn': 'companion-unicornito-unicorn.png'
  }

  const imagePath = companionImages[companion.type] || `companion-${companion.type}.png`

  // Colores tem√°ticos para el chat de cada personaje
  const companionThemes = {
    'hada-fairy': { from: '#DB7093', to: '#C25283', name: 'Hada' },
    'hada': { from: '#DB7093', to: '#C25283', name: 'Hada' },
    'unicornito-unicorn': { from: '#9370DB', to: '#7B5DCB', name: 'Unicornito' },
    'unicornito': { from: '#9370DB', to: '#7B5DCB', name: 'Unicornito' },
    'fabel-animal': { from: '#FFC107', to: '#FFA000', name: 'Fabel' },
    'fabel': { from: '#FFC107', to: '#FFA000', name: 'Fabel' },
    'elfo-elf': { from: '#4CAF50', to: '#388E3C', name: 'Elfo' },
    'elfo': { from: '#4CAF50', to: '#388E3C', name: 'Elfo' },
    'draguito-dragon': { from: '#F44336', to: '#D32F2F', name: 'Draguito' },
    'draguito': { from: '#F44336', to: '#D32F2F', name: 'Draguito' },
    'lumi-light': { from: '#FFEB3B', to: '#FBC02D', name: 'Lumi' },
    'lumi': { from: '#FFEB3B', to: '#FBC02D', name: 'Lumi' },
    'nimbo-cloud': { from: '#2196F3', to: '#1976D2', name: 'Nimbo' },
    'nimbo': { from: '#2196F3', to: '#1976D2', name: 'Nimbo' },
    'human-warm': { from: '#FF9800', to: '#F57C00', name: 'Humano' },
    'human': { from: '#FF9800', to: '#F57C00', name: 'Humano' },
    'sprig-plant': { from: '#8BC34A', to: '#689F38', name: 'Sprig' },
    'sprig': { from: '#8BC34A', to: '#689F38', name: 'Sprig' },
    'ken': { from: '#8B4513', to: '#654321', name: 'Ken' }
  }

  const theme = companionThemes[companion.type as keyof typeof companionThemes] || { from: '#D4AF37', to: '#B8941F', name: companion.name }

  return (
    <>
      {/* PERSONAJE FLOTANTE - FONDO TRANSPARENTE CON LUCES Y DEGRADADOS ORIGINALES */}
      <motion.div
        className="fixed bottom-20 right-10 z-[99999] pointer-events-none group"
        initial={{ opacity: 0, scale: 0 }}
        animate={{ 
          opacity: 1, 
          scale: 1
        }}
        transition={{ 
          opacity: { duration: 0.5 },
          scale: { duration: 0.5 }
        }}
      >
        {/* IMAGEN DEL PERSONAJE - SOLO SILUETA CON TRANSPARENCIA */}
        <motion.div
          className="pointer-events-auto cursor-pointer relative flex items-center justify-center" 
          onClick={() => setShowChat(true)}
          animate={{
            y: companion.type === 'ken' ? [0, -8, 0] : [0, -12, 0]
          }}
          transition={{
            duration: companion.type === 'ken' ? 4 : 3,
            repeat: Infinity,
            ease: "easeInOut"
          }}
          style={{ width: '192px', height: '192px' }}
        >
          {/* Si es Ken, usar el componente animado especial */}
          {companion.type === 'ken' ? (
            <KenCompanion size={192} showAura={true} interactive={true} />
          ) : (
            <Image
              src={`/images/companions/${imagePath}`}
              alt={companion.name}
              width={192}
              height={192}
              className="object-contain w-full h-full"
              style={{ 
                filter: 'drop-shadow(0 4px 16px rgba(0, 0, 0, 0.2))'
              }}
              priority
              unoptimized
            />
          )}
        </motion.div>

        {/* Botones flotantes (esquina superior del personaje) */}
        <div className="absolute -top-2 -right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto">
          {/* Bot√≥n de Historia */}
          <motion.button
            onClick={(e) => {
              e.stopPropagation()
              setShowStory(true)
              setEmotion('happy')
            }}
            className="w-10 h-10 rounded-full bg-white border-2 shadow-lg flex items-center justify-center hover:scale-110"
            style={{
              borderColor: theme.from
            }}
            whileHover={{ scale: 1.15 }}
            whileTap={{ scale: 0.95 }}
            title={`Ver la historia de ${companion.name}`}
          >
            <BookOpen className="w-5 h-5" style={{ color: theme.to }} />
          </motion.button>

          {/* Bot√≥n de Configuraci√≥n */}
          <motion.button
            onClick={(e) => {
              e.stopPropagation()
              setShowSettings(true)
              setEmotion('thinking')
            }}
            className="w-10 h-10 rounded-full bg-white border-2 shadow-lg flex items-center justify-center hover:scale-110"
            style={{
              borderColor: theme.from
            }}
            whileHover={{ scale: 1.15 }}
            whileTap={{ scale: 0.95 }}
            title="Configuraci√≥n"
          >
            <Settings className="w-5 h-5" style={{ color: theme.to }} />
          </motion.button>
        </div>

        {/* Indicador de estado activo - SOLO GLOW, SIN FONDO */}
        <motion.div
          className="absolute top-0 right-0"
          animate={{
            scale: [1, 1.5, 1],
            opacity: [0.7, 1, 0.7]
          }}
          transition={{
            duration: 2.5,
            repeat: Infinity,
            ease: "easeInOut"
          }}
        >
          <div className="relative w-6 h-6">
            <motion.div 
              className="absolute inset-0 rounded-full bg-green-400/70 blur-md"
              animate={{
                scale: [1, 1.4, 1],
                opacity: [0.6, 0.9, 0.6]
              }}
              transition={{
                duration: 2,
                repeat: Infinity,
                ease: "easeInOut"
              }}
            />
            <span className="absolute inset-0 flex items-center justify-center text-white text-xl drop-shadow-[0_0_8px_rgba(52,211,153,1)]">‚ú®</span>
          </div>
        </motion.div>
      </motion.div>

      {/* PANEL DE CHAT PERSONALIZADO - A LA IZQUIERDA DEL PERSONAJE */}
      <AnimatePresence>
        {showChat && (
          <motion.div
            initial={{ opacity: 0, x: 20 }}
            animate={{ opacity: 1, x: 0 }}
            exit={{ opacity: 0, x: 20 }}
            transition={{ type: "spring", bounce: 0.3 }}
            className="fixed bottom-8 right-[250px] w-[440px] max-w-[calc(100vw-300px)] h-[600px] max-h-[calc(100vh-8rem)] z-[50000] shadow-2xl"
          >
            <div className="bg-white rounded-2xl overflow-hidden h-full flex flex-col" style={{
              border: `2px solid ${theme.from}40`
            }}>
              <div 
                className="p-5 flex items-center justify-between flex-shrink-0"
                style={{
                  background: `linear-gradient(135deg, ${theme.from} 0%, ${theme.to} 100%)`
                }}
              >
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                    {chatMode === 'voice' ? (
                      <Mic className="w-6 h-6 text-white" />
                    ) : (
                      <MessageCircle className="w-6 h-6 text-white" />
                    )}
                  </div>
                  <div>
                    <h3 className="font-semibold text-white text-lg">{companion.name}</h3>
                    <p className="text-xs text-white/90">
                      {chatMode === 'voice' ? 'üé§ Chat por Voz' : 'üí¨ Chat de Texto'}
                    </p>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  {/* Bot√≥n de cerrar */}
                  <Button
                    size="sm"
                    variant="ghost"
                    onClick={() => {
                      setShowChat(false)
                      setEmotion('neutral')
                      setAction('idle')
                    }}
                    className="text-white hover:bg-white/20 rounded-full"
                  >
                    <X className="w-5 h-5" />
                  </Button>
                </div>
              </div>
              <div className="flex-1 overflow-y-auto">
                {chatMode === 'voice' ? (
                  <ImprovedVoiceChat companion={companion} />
                ) : (
                  <CompanionChat companion={companion} companionTheme={theme} />
                )}
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* PANEL DE CONFIGURACI√ìN */}
      <AnimatePresence>
        {showSettings && (
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.95 }}
            className="fixed inset-4 md:right-8 md:left-auto md:w-[500px] md:top-1/2 md:-translate-y-1/2 z-[99999] shadow-2xl"
          >
            <div className="bg-white rounded-2xl border-2 border-[#D4AF37]/30 overflow-hidden h-full md:h-auto">
              <div className="bg-gradient-to-r from-[#D4AF37] to-[#B8941F] p-4 flex items-center justify-between">
                <h3 className="font-semibold text-white">Configuraci√≥n de {companion.name}</h3>
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={() => {
                    setShowSettings(false)
                    setEmotion('neutral')
                  }}
                  className="text-white hover:bg-white/20"
                >
                  <X className="w-4 h-4" />
                </Button>
              </div>
              <CompanionSettings
                companion={companion}
                onUpdate={(data) => {
                  onUpdate(data)
                  setShowSettings(false)
                  setEmotion('happy')
                  setAction('dancing')
                  setTimeout(() => setAction('idle'), 2000)
                }}
                onClose={() => {
                  setShowSettings(false)
                  setEmotion('neutral')
                }}
              />
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* PANEL DE HISTORIA */}
      {showStory && (
        <CompanionStoryPanel
          companionId={COMPANION_ID_MAP[companion.type] || companion.type}
          onClose={() => {
            setShowStory(false)
            setEmotion('neutral')
          }}
        />
      )}
    </>
  )
}
