
'use client'

import { useState, useEffect } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { MessageCircle, Settings, X, Sparkles, Mic } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { CompanionSettings } from './companion-settings'
import Image from 'next/image'
import { CompanionChat } from './companion-chat'
import { KenLivingCompanion } from './ken-living'
import { ImprovedVoiceChat } from './improved-voice-chat'
import { detectEmotion, analyzeEmotionalContext, DetectedEmotion } from '@/lib/emotion-detector'
import EmotionParticles from './emotion-particles'
import { getEmotionAnimation,   } from '@/lib/emotion-animations'

interface FloatingCompanionProps {
  companion: {
    id: string
    type: string
    name: string
    color_theme: string
    voice_tone: string
    personality: string
    position_x: number
    position_y: number
    is_active: boolean
  }
  onUpdate: (data: any) => void
}

export function FloatingCompanion({ companion, onUpdate }: FloatingCompanionProps) {
  const [showSettings, setShowSettings] = useState(false)
  const [showChat, setShowChat] = useState(false)
  const [chatMode, setChatMode] = useState<'text' | 'voice'>('text') // Modo de chat: texto o voz
  const [currentEmotion, setCurrentEmotion] = useState<DetectedEmotion>('calm')

  // Efecto de emociones sutiles aleatorias cuando no est√° en chat
  useEffect(() => {
    if (!showChat) {
      const emotions: DetectedEmotion[] = ['calm', 'happy']
      const interval = setInterval(() => {
        const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)]
        setCurrentEmotion(randomEmotion)
      }, 8000)

      return () => clearInterval(interval)
    }
  }, [showChat])

  if (!companion.is_active) {
    return null
  }

  // Colores de brillo seg√∫n el companion
  const companionImages: Record<string, string> = {
    'human': 'companion-human-warm.png',
    'lumi': 'companion-lumi-light.png',
    'nimbo': 'companion-nimbo-cloud.png',
    'fabel': 'companion-fabel-animal.png',
    'sprig': 'companion-sprig-plant.png',
    'hada': 'companion-hada-fairy.png',
    'elfo': 'companion-elfo-elf.png',
    'draguito': 'companion-draguito-dragon.png',
    'unicornito': 'companion-unicornito-unicorn.png',
    'human-warm': 'companion-human-warm.png',
    'lumi-light': 'companion-lumi-light.png',
    'nimbo-cloud': 'companion-nimbo-cloud.png',
    'fabel-animal': 'companion-fabel-animal.png',
    'sprig-plant': 'companion-sprig-plant.png',
    'hada-fairy': 'companion-hada-fairy.png',
    'elfo-elf': 'companion-elfo-elf.png',
    'draguito-dragon': 'companion-draguito-dragon.png',
    'unicornito-unicorn': 'companion-unicornito-unicorn.png'
  }

  const glowColors = {
    'hada-fairy': 'rgba(219, 112, 147, 0.8)',
    'hada': 'rgba(219, 112, 147, 0.8)',
    'unicornito-unicorn': 'rgba(147, 112, 219, 0.8)',
    'unicornito': 'rgba(147, 112, 219, 0.8)',
    'fabel-animal': 'rgba(255, 193, 7, 0.8)',
    'fabel': 'rgba(255, 193, 7, 0.8)',
    'elfo-elf': 'rgba(76, 175, 80, 0.8)',
    'elfo': 'rgba(76, 175, 80, 0.8)',
    'draguito-dragon': 'rgba(244, 67, 54, 0.8)',
    'draguito': 'rgba(244, 67, 54, 0.8)',
    'lumi-light': 'rgba(255, 235, 59, 0.9)',
    'lumi': 'rgba(255, 235, 59, 0.9)',
    'nimbo-cloud': 'rgba(33, 150, 243, 0.8)',
    'nimbo': 'rgba(33, 150, 243, 0.8)',
    'human-warm': 'rgba(255, 152, 0, 0.8)',
    'human': 'rgba(255, 152, 0, 0.8)',
    'sprig-plant': 'rgba(139, 195, 74, 0.8)',
    'sprig': 'rgba(139, 195, 74, 0.8)'
  }

  const companionThemes = {
    'hada-fairy': { from: '#DB7093', to: '#C25283', name: 'Hada' },
    'hada': { from: '#DB7093', to: '#C25283', name: 'Hada' },
    'unicornito-unicorn': { from: '#9370DB', to: '#7B5DCB', name: 'Unicornito' },
    'unicornito': { from: '#9370DB', to: '#7B5DCB', name: 'Unicornito' },
    'fabel-animal': { from: '#FFC107', to: '#FFA000', name: 'Fabel' },
    'fabel': { from: '#FFC107', to: '#FFA000', name: 'Fabel' },
    'elfo-elf': { from: '#4CAF50', to: '#388E3C', name: 'Elfo' },
    'elfo': { from: '#4CAF50', to: '#388E3C', name: 'Elfo' },
    'draguito-dragon': { from: '#F44336', to: '#D32F2F', name: 'Draguito' },
    'draguito': { from: '#F44336', to: '#D32F2F', name: 'Draguito' },
    'lumi-light': { from: '#FFEB3B', to: '#FBC02D', name: 'Lumi' },
    'lumi': { from: '#FFEB3B', to: '#FBC02D', name: 'Lumi' },
    'nimbo-cloud': { from: '#2196F3', to: '#1976D2', name: 'Nimbo' },
    'nimbo': { from: '#2196F3', to: '#1976D2', name: 'Nimbo' },
    'human-warm': { from: '#FF9800', to: '#F57C00', name: 'Humano' },
    'human': { from: '#FF9800', to: '#F57C00', name: 'Humano' },
    'sprig-plant': { from: '#8BC34A', to: '#689F38', name: 'Sprig' },
    'sprig': { from: '#8BC34A', to: '#689F38', name: 'Sprig' }
  }

  const imagePath = companionImages[companion.type] || `companion-${companion.type}.png`
  const glowColor = glowColors[companion.type as keyof typeof glowColors] || 'rgba(212, 175, 55, 0.8)'
  const theme = companionThemes[companion.type as keyof typeof companionThemes] || { from: '#D4AF37', to: '#B8941F', name: companion.name }
  
  // Obtener animaciones emocionales del nuevo sistema
  const emotionVisuals = getEmotionAnimation(currentEmotion as DetectedEmotion)
  const ambientGlow = (currentEmotion as DetectedEmotion)

  return (
    <>
      {/* ACOMPA√ëANTE FLOTANTE CON EFECTOS VISUALES DRAM√ÅTICOS */}
      <div className="fixed bottom-6 right-6 z-[99999] pointer-events-auto group">
        <motion.div
          initial={{ scale: 0, opacity: 0 }}
          animate={{ scale: 1, opacity: 1 }}
          transition={{ duration: 0.5 }}
          className="relative"
        >
          {/* PERSONAJE CON EFECTOS VISUALES SEG√öN EMOCI√ìN */}
          <motion.div 
            className="cursor-pointer relative"
            onClick={() => setShowChat(true)}
            title={`Haz clic para hablar con ${companion.name}`}
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.98 }}
            animate={{
              y: companion.type === 'ken' ? 0 : [0, -8, 0],
              rotate: companion.type === 'ken' ? 0 : [0, 2, -2, 0]
            }}
            transition={{
              duration: 3,
              repeat: Infinity,
              ease: "easeInOut"
            }}
          >
            {companion.type === 'ken' ? (
              /* KEN CON ANIMACI√ìN REAL Y DETECCI√ìN EMOCIONAL */
              <div className="relative" style={{ width: '500px', height: '500px', maxHeight: 'calc(100vh - 180px)' }}>
                <KenLivingCompanion
                  size={500}
                  showAura={true}
                  interactive={true}
                  currentEmotion={
                    // Mapeo de emociones del chat a emociones de Ken
                    currentEmotion === 'excited' ? 'excited' :
                    currentEmotion === 'anxious' ? 'anxious' :
                    currentEmotion === 'sad' ? 'sad' :
                    currentEmotion === 'happy' ? 'happy' : 
                    currentEmotion === 'protective' ? 'protective' :
                    'calm' // default (calm)
                  }
                />
              </div>
            ) : (
              /* OTROS COMPANIONS CON PNG Y ANIMACIONES EMOCIONALES */
              <>            
                {/* AURA EMOCIONAL DIN√ÅMICA */}
                <motion.div
                  className={`absolute inset-0 rounded-full ${auraGradient}`}
                  style={{
                    filter: `blur(40px)`,
                  }}
                  animate={{
                    scale: [1, 1.2, 1],
                    opacity: [0.3, emotionVisuals.aura.intensity * 0.6, 0.3]
                  }}
                  transition={{
                    duration: 2,
                    repeat: Infinity,
                    ease: "easeInOut"
                  }}
                />

                {/* PART√çCULAS EMOCIONALES */}
                <EmotionParticles 
                  emotion={currentEmotion as DetectedEmotion}
                  companionType={companion.type}
                />

                {/* IMAGEN DEL COMPANION CON FILTRO AMBIENTAL */}
                <div className="relative flex items-center justify-center" style={{ width: '500px', height: '500px', maxHeight: 'calc(100vh - 180px)' }}>
                  <motion.div
                    className="w-full h-full"
                    style={{
                      filter: ambientGlow
                    }}
                    animate={{
                      scale: [1, 1.02, 1]
                    }}
                    transition={{
                      duration: 2,
                      repeat: Infinity,
                      ease: "easeInOut"
                    }}
                  >
                    <Image
                      src={`/images/companions/${imagePath}`}
                      alt={companion.name}
                      width={500}
                      height={500}
                      className="object-contain w-full h-full"
                      priority
                      unoptimized
                    />
                  </motion.div>
                </div>
              </>
            )}
          </motion.div>

          {/* Indicador de emoci√≥n visual */}
          <AnimatePresence>
            {currentEmotion !== 'calm' && (
              <motion.div 
                initial={{ scale: 0, opacity: 0 }}
                animate={{ scale: 1, opacity: 1 }}
                exit={{ scale: 0, opacity: 0 }}
                className="absolute -top-4 -right-4 pointer-events-none"
              >
                <motion.div
                  className={`w-16 h-16 rounded-full ${auraGradient} shadow-xl flex items-center justify-center`}
                  animate={{
                    scale: [1, 1.1, 1],
                    rotate: [0, 5, -5, 0]
                  }}
                  transition={{
                    duration: 1.5,
                    repeat: Infinity,
                    ease: "easeInOut"
                  }}
                >
                  <span className="text-3xl">
                    {emotionVisuals.particles[0]?.emoji || '‚ú®'}
                  </span>
                </motion.div>
              </motion.div>
            )}
          </AnimatePresence>

          {/* Tooltip al hover */}
          <motion.div 
            className="absolute bottom-full mb-4 right-0 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"
          >
            <div className="bg-[#8B7355] text-white px-4 py-2 rounded-xl text-sm shadow-xl">
              <div className="font-semibold flex items-center gap-2">
                <Sparkles className="w-3 h-3" />
                {companion.name}
              </div>
              <div className="text-xs opacity-90 mt-1">Haz clic para chatear</div>
            </div>
          </motion.div>

          {/* Bot√≥n de configuraci√≥n */}
          <motion.button
            onClick={(e) => {
              e.stopPropagation()
              setShowSettings(true)
            }}
            className="absolute -top-2 -right-2 w-10 h-10 rounded-full bg-white border-2 border-[#D4AF37] shadow-lg flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:scale-110"
            whileHover={{ scale: 1.15 }}
            whileTap={{ scale: 0.95 }}
          >
            <Settings className="w-5 h-5 text-[#8B7355]" />
          </motion.button>
        </motion.div>
      </div>

      {/* PANEL DE CHAT */}
      {showChat && (
        <motion.div
          initial={{ opacity: 0, x: 20 }}
          animate={{ opacity: 1, x: 0 }}
          className="fixed bottom-8 right-[540px] w-[440px] max-w-[calc(100vw-580px)] h-[600px] max-h-[calc(100vh-8rem)] z-[50000] shadow-2xl"
        >
          <div className="bg-white rounded-2xl overflow-hidden h-full flex flex-col" style={{
            border: `2px solid ${theme.from}40`
          }}>
            {/* Header con selector de modo */}
            <div 
              className="p-4 flex-shrink-0"
              style={{
                background: `linear-gradient(135deg, ${theme.from} 0%, ${theme.to} 100%)`
              }}
            >
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-3">
                  {chatMode === 'text' ? (
                    <MessageCircle className="w-6 h-6 text-white" />
                  ) : (
                    <Mic className="w-6 h-6 text-white" />
                  )}
                  <div>
                    <h3 className="font-semibold text-white text-lg">{companion.name}</h3>
                    <p className="text-xs text-white/90 flex items-center gap-1">
                      <span className="inline-block w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                      {chatMode === 'text' ? 'Con voces expresivas autom√°ticas' : 'Chat por voz con micr√≥fono'}
                    </p>
                  </div>
                </div>
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={() => setShowChat(false)}
                  className="text-white hover:bg-white/20 rounded-full"
                >
                  <X className="w-5 h-5" />
                </Button>
              </div>

              {/* Selector de modo: Texto o Voz */}
              <div className="flex gap-2">
                <Button
                  size="sm"
                  variant={chatMode === 'text' ? 'secondary' : 'ghost'}
                  onClick={() => setChatMode('text')}
                  className={`flex-1 ${chatMode === 'text' ? 'bg-white text-[#8B7355]' : 'text-white/90 hover:bg-white/20'}`}
                >
                  <MessageCircle className="w-4 h-4 mr-2" />
                  Texto
                </Button>
                <Button
                  size="sm"
                  variant={chatMode === 'voice' ? 'secondary' : 'ghost'}
                  onClick={() => setChatMode('voice')}
                  className={`flex-1 ${chatMode === 'voice' ? 'bg-white text-[#8B7355]' : 'text-white/90 hover:bg-white/20'}`}
                >
                  <Mic className="w-4 h-4 mr-2" />
                  Voz
                </Button>
              </div>
            </div>

            {/* Chat seg√∫n el modo seleccionado */}
            <div className="flex-1 overflow-hidden">
              {chatMode === 'text' ? (
                <CompanionChat 
                  companion={companion}
                  companionTheme={theme}
                  onEmotionChange={(emotion: DetectedEmotion) => setCurrentEmotion(emotion)}
                />
              ) : (
                <ImprovedVoiceChat 
                  companion={companion}
                  onVoiceUsage={(minutesUsed, minutesRemaining) => {
                    console.log('üé§ Uso de voz:', { minutesUsed, minutesRemaining })
                  }}
                  onEmotionChange={(emotion) => {
                    // Mapear emociones del texto a emociones visuales
                    const emotionMap: Record<string, DetectedEmotion> = {
                      'excited': 'excited',
                      'warm': 'happy',
                      'calm': 'calm',
                      'sad': 'sad',
                      'energetic': 'happy'
                    }
                    const visualEmotion = emotionMap[emotion] || 'calm'
                    setCurrentEmotion(visualEmotion)
                  }}
                />
              )}
            </div>
          </div>
        </motion.div>
      )}

      {/* PANEL DE CONFIGURACI√ìN */}
      {showSettings && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          className="fixed inset-4 md:right-8 md:left-auto md:w-[500px] md:top-1/2 md:-translate-y-1/2 z-[99999] shadow-2xl"
        >
          <div className="bg-white rounded-2xl border-2 border-[#D4AF37]/30 overflow-hidden h-full md:h-auto">
            <div className="bg-gradient-to-r from-[#D4AF37] to-[#B8941F] p-4 flex items-center justify-between">
              <h3 className="font-semibold text-white">Configuraci√≥n de {companion.name}</h3>
              <Button
                size="sm"
                variant="ghost"
                onClick={() => setShowSettings(false)}
                className="text-white hover:bg-white/20"
              >
                <X className="w-4 h-4" />
              </Button>
            </div>
            <CompanionSettings
              companion={companion}
              onUpdate={(data) => {
                onUpdate(data)
                setShowSettings(false)
              }}
              onClose={() => setShowSettings(false)}
            />
          </div>
        </motion.div>
      )}


    </>
  )
}
