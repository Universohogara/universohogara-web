
'use client'

import { motion } from 'framer-motion'
import Image from 'next/image'
import { useState, useEffect, useRef } from 'react'
import { DetectedEmotion } from '@/lib/emotion-detector'

interface KenLivingCompanionProps {
  size?: number
  showAura?: boolean
  interactive?: boolean
  currentEmotion?: DetectedEmotion
}

const TOTAL_FRAMES = 24  // Ken cartoon guardián - 24 frames dibujados
const FPS = 3  // Animación suave y sutil - 3 frames por segundo

export function KenLivingCompanion({ 
  size = 300, 
  showAura = true, 
  interactive = true,
  currentEmotion = 'calm'
}: KenLivingCompanionProps) {
  const [currentFrame, setCurrentFrame] = useState(0)
  const frameIntervalRef = useRef<NodeJS.Timeout | null>(null)

  // Animación de frames suave (3 FPS)
  useEffect(() => {
    const frameDelay = 1000 / FPS
    
    frameIntervalRef.current = setInterval(() => {
      setCurrentFrame(prev => (prev + 1) % TOTAL_FRAMES)
    }, frameDelay)

    return () => {
      if (frameIntervalRef.current) {
        clearInterval(frameIntervalRef.current)
      }
    }
  }, [])

  // Formatear número de frame - USAR FRAMES DE KEN CARTOON GUARDIÁN
  const frameNumber = String(currentFrame).padStart(3, '0')
  const framePath = `/images/companions/ken/ken_guardian_${frameNumber}.png`

  // Configuración visual según emoción
//     auraColor: string
//     auraIntensity: number
//     floatAmount: number
//     floatSpeed: number
//     scale: number
//     particles: number
//   }> = {
 //     calm: {
 //       auraColor: 'rgba(255, 200, 100, 0.4)',
 //       auraIntensity: 0.3,
 //       floatAmount: 2,
 //       floatSpeed: 5,
 //       scale: 1.0,
 //       particles: 3
 //     },
 //     happy: {
 //       auraColor: 'rgba(255, 220, 120, 0.6)',
 //       auraIntensity: 0.5,
 //       floatAmount: 4,
 //       floatSpeed: 3,
 //       scale: 1.02,
 //       particles: 6
 //     },
 //     sad: {
 //       auraColor: 'rgba(180, 200, 255, 0.3)',
 //       auraIntensity: 0.2,
 //       floatAmount: 1,
 //       floatSpeed: 7,
 //       scale: 0.98,
 //       particles: 2
 //     },
 //     excited: {
 //       auraColor: 'rgba(255, 180, 80, 0.7)',
 //       auraIntensity: 0.6,
 //       floatAmount: 6,
 //       floatSpeed: 2,
 //       scale: 1.05,
 //       particles: 8
 //     },
 //     anxious: {
 //       auraColor: 'rgba(255, 150, 150, 0.4)',
 //       auraIntensity: 0.4,
 //       floatAmount: 3,
 //       floatSpeed: 2.5,
 //       scale: 1.0,
 //       particles: 4
 //     },
 //     protective: {
 //       auraColor: 'rgba(255, 160, 60, 0.7)',
 //       auraIntensity: 0.7,
 //       floatAmount: 3,
 //       floatSpeed: 4,
 //       scale: 1.03,
 //       particles: 5
 //     }
 //   }


  return (
    <div className="relative" style={{ width: size, height: size }}>
      {/* Aura mágica adaptada a la emoción */}
      {showAura && (
        <>
          {/* Resplandor principal */}
          <motion.div
            className="absolute inset-0 rounded-full blur-3xl -z-10"
            animate={{
              scale: [1, 1.2, 1],
              opacity: [config.auraIntensity * 0.8, config.auraIntensity, config.auraIntensity * 0.8]
            }}
            transition={{
              duration: 4,
              repeat: Infinity,
              ease: "easeInOut"
            }}
            style={{ 
              backgroundColor: config.auraColor,
              filter: 'blur(40px)'
            }}
          />
          
          {/* Partículas flotantes sutiles */}
          {[...Array(config.particles)].map((_, i) => {
            const angle = (i * 360) / config.particles
            const distance = size * 0.5
            const x = Math.cos((angle * Math.PI) / 180) * distance
            const y = Math.sin((angle * Math.PI) / 180) * distance
            
            return (
              <motion.div
                key={`particle-${i}`}
                className="absolute top-1/2 left-1/2 w-1.5 h-1.5 rounded-full"
                style={{ backgroundColor: config.auraColor }}
                animate={{
                  x: [0, x * 0.2, 0],
                  y: [0, y * 0.2, 0],
                  opacity: [0.3, 0.6, 0.3],
                  scale: [0.8, 1.1, 0.8]
                }}
                transition={{
                  duration: 4,
                  repeat: Infinity,
                  delay: i * 0.3,
                  ease: "easeInOut"
                }}
              />
            )
          })}
        </>
      )}

      {/* Ken animado - MOVIMIENTO SUTIL */}
      <motion.div
        className="relative w-full h-full"
        animate={{
          y: [-config.floatAmount, config.floatAmount, -config.floatAmount],
          scale: [config.scale, config.scale * 1.01, config.scale],
          x: currentEmotion === 'excited' ? [-1, 1, -1] : [0, 0, 0]
        }}
        transition={{
          duration: config.floatSpeed,
          repeat: Infinity,
          ease: "easeInOut"
        }}
        whileHover={interactive ? { 
          scale: config.scale * 1.05,
          transition: { duration: 0.3 }
        } : {}}
      >
        <div className="relative w-full h-full">
          <Image
            src={framePath}
            alt={`Ken - ${currentEmotion}`}
            fill
            className="object-contain"
            style={{ 
              filter: `drop-shadow(0 0 ${8 + config.auraIntensity * 10}px ${config.auraColor})`
            }}
            unoptimized
            priority
          />
        </div>
      </motion.div>

      {/* Indicador de emoción en desarrollo */}
      {process.env.NODE_ENV === 'development' && (
        <div className="absolute -bottom-8 left-0 right-0 text-center text-xs text-gray-500">
          Ken: {currentEmotion} | Frame: {currentFrame}/{TOTAL_FRAMES} | {FPS} FPS
        </div>
      )}
    </div>
  )
}

export default KenLivingCompanion
